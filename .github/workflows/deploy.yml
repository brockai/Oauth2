name: Deploy OAuth2 Services

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    # Build Server
    - name: Install server dependencies
      run: npm ci

    - name: Build server artifacts
      run: |
        mkdir -p dist/server
        cp -r controllers dist/server/
        cp -r middleware dist/server/
        cp -r routes dist/server/
        cp -r database dist/server/
        cp -r migrations dist/server/
        cp -r config dist/server/
        cp -r scripts dist/server/
        cp server.js dist/server/
        cp package*.json dist/server/

    # Build Client
    - name: Install client dependencies
      run: |
        cd client
        npm ci

    - name: Build client
      run: |
        cd client
        # Set production API URL from secrets
        export NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}"
        # Replace localhost API docs URLs with production URLs
        sed -i 's|http://localhost:3000/api-docs|${{ secrets.NEXT_PUBLIC_API_URL }}/api-docs/|g' pages/login.js
        sed -i 's|http://localhost:3001/api-docs|${{ secrets.NEXT_PUBLIC_API_URL }}/api-docs/|g' pages/api-keys.js
        npm run build
        mkdir -p ../dist/client
        cp -r .next ../dist/client/
        cp package*.json ../dist/client/
        cp next.config.js ../dist/client/
        # Copy other necessary files
        cp -r styles ../dist/client/
        cp -r pages ../dist/client/
        cp -r components ../dist/client/
        cp -r hooks ../dist/client/
        cp -r lib ../dist/client/
        cp -r public ../dist/client/
        cp postcss.config.js ../dist/client/
        cp tailwind.config.js ../dist/client/

    # Deploy to server
    - name: Deploy both services to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Stop existing services
          pm2 stop oauth2-server || true
          pm2 stop oauth2-client || true
          pm2 stop oauth2-demo-server || true
          
          # Prepare server directories
          mkdir -p /var/www/oauth2.api/server
          rm -rf /var/www/oauth2.api/server/*
          
          mkdir -p /var/www/oauth2.demo/server
          rm -rf /var/www/oauth2.demo/server/*
          
          # Prepare client directory (single client for both environments)
          mkdir -p /var/www/oauth2.console/client
          rm -rf /var/www/oauth2.console/client/*

    - name: Copy server files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/server/*"
        target: "/var/www/oauth2.api/server"
        strip_components: 2

    - name: Copy demo server files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/server/*"
        target: "/var/www/oauth2.demo/server"
        strip_components: 2

    - name: Copy client files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/client/*"
        target: "/var/www/oauth2.console/client"
        strip_components: 2

    - name: Copy docker-compose file
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "docker-compose.yml"
        target: "/var/www/oauth2-postgres/"

    - name: Install dependencies and start services
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Start PostgreSQL container
          cd /var/www/oauth2-postgres
          docker compose up -d postgres
          
          # Wait for PostgreSQL to be ready
          sleep 10
          
          # Install production server dependencies and create .env
          cd /var/www/oauth2.api/server
          npm ci --production
          
          # Create .env file with production settings from secrets
          cat > .env << EOF
          NODE_ENV=${{ secrets.NODE_ENV }}
          PORT=${{ secrets.PORT }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          DB_MODE=main
          EOF
          
          # Install demo server dependencies and create .env
          cd /var/www/oauth2.demo/server
          npm ci --production
          
          # Create .env file with demo settings
          cat > .env << EOF
          NODE_ENV=${{ secrets.NODE_ENV }}
          PORT=3001
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_DEMO_NAME }}
          DB_USER=${{ secrets.DB_DEMO_USER }}
          DB_PASSWORD=${{ secrets.DB_DEMO_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_DEMO_URL }}
          JWT_SECRET=${{ secrets.JWT_DEMO_SECRET }}
          DB_MODE=demo
          EOF
          
          # Wait longer for PostgreSQL to be fully ready
          sleep 5
          
          # Run database migrations
          echo "Running database migrations..."
          npm run migrate || echo "Migration failed, but continuing deployment"
          
          # Verify tables exist
          echo "Verifying database tables..."
          node -e "
          const { Pool } = require('pg');
          const pool = new Pool({ connectionString: process.env.DATABASE_URL });
          pool.query('SELECT tablename FROM pg_tables WHERE schemaname = \\'public\\';')
            .then(res => console.log('Tables:', res.rows.map(r => r.tablename)))
            .catch(err => console.error('DB check failed:', err.message))
            .finally(() => pool.end());
          " || echo "Database verification failed"
          
          # Sync demo database
          echo "Syncing demo database..."
          npm run sync-demo || echo "Demo database sync failed, but continuing deployment"
          
          # Install production client dependencies
          cd /var/www/oauth2.console/client
          npm ci --production
          
          # Create production client .env
          cat > .env.local << EOF
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          EOF
          
          # Install demo client dependencies  
          cd /var/www/oauth2.demo/client
          npm ci --production
          
          # Create demo client .env
          cat > .env.local << EOF
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          EOF
          
          # Start or restart all services with PM2
          cd /var/www/oauth2.api/server
          pm2 restart oauth2-server || pm2 start server.js --name oauth2-server
          
          cd /var/www/oauth2.demo/server
          pm2 restart oauth2-demo-server || pm2 start server.js --name oauth2-demo-server
          
          cd /var/www/oauth2.console/client
          pm2 restart oauth2-client || pm2 start "npm start" --name oauth2-client
          
          cd /var/www/oauth2.demo/client
          pm2 restart oauth2-demo-client || pm2 start "npm start" --name oauth2-demo-client